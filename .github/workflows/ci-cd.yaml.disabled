name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Detect Changes (Path Filtering)
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'app/**'
              - 'public/**'
              - 'package.json'
              - 'next.config.ts'
            backend:
              - 'aws/**'

  # 2. Frontend Check (Lint & Build Test Only)
  # We let Vercel handle the actual deployment automatically!
  frontend-check:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci

      - name: Check Code Quality (Lint)
        run: npm run lint

      - name: Verify Build (Dry Run)
        run: npm run build
        # If this passes, Vercel's automatic deployment will likely succeed too.

  # 3. Backend Deploy (AWS Lambda)
  # AWS needs this because it doesn't auto-deploy like Vercel.
  backend:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript Lambdas
        run: npm run build:backend

      - name: Run Unit Tests (Jest)
        run: npm test

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: SAM Build
        run: |
          cd aws
          sam build

      - name: SAM Deploy
        run: |
          cd aws
          sam deploy --no-confirm-changeset --no-fail-on-empty-changeset